const express = require('express');
const multer = require('multer');
const fs = require('fs').promises;
const path = require('path');
const { Twilio } = require('twilio');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// Configure multer for file uploads
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, 'uploads/');
  },
  filename: (req, file, cb) => {
    cb(null, Date.now() + '-' + file.originalname);
  }
});
const upload = multer({ storage: storage });

// Twilio configuration
const client = new Twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN);

// Data storage (in production, use a proper database)
let notes = [];
let userProfiles = {};

// Ensure uploads directory exists
const ensureUploadsDir = async () => {
  try {
    await fs.access('uploads');
  } catch {
    await fs.mkdir('uploads', { recursive: true });
  }
};

// DeepSeek AI API function (free tier)
const callDeepSeekAPI = async (prompt) => {
  try {
    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`
      },
      body: JSON.stringify({
        model: "deepseek-chat",
        messages: [
          {
            role: "system",
            content: "You are a helpful assistant for a Marathi-speaking parent of a mentally disabled child. You can translate between Marathi and English, summarize notes, and provide supportive responses."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        max_tokens: 1000
      })
    });

    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    console.error('DeepSeek API Error:', error);
    return 'माफ करा, AI सेवा सध्या उपलब्ध नाही. (Sorry, AI service is currently unavailable.)';
  }
};

// Google TTS function (free tier)
const generateTTS = async (text, language = 'mr') => {
  try {
    const response = await fetch(`https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=${language}&client=tw-ob`, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      }
    });
    
    if (response.ok) {
      return response.url;
    }
    return null;
  } catch (error) {
    console.error('TTS Error:', error);
    return null;
  }
};

// Save note function
const saveNote = async (phoneNumber, content, type = 'text', mediaUrl = null) => {
  const note = {
    id: Date.now().toString(),
    phoneNumber,
    content,
    type, // 'text', 'voice', 'image', 'video'
    mediaUrl,
    timestamp: new Date().toISOString(),
    dateFormatted: new Date().toLocaleString('mr-IN', {
      timeZone: 'Asia/Kolkata',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  };
  
  notes.push(note);
  
  // In production, save to database
  try {
    await fs.writeFile('notes.json', JSON.stringify(notes, null, 2));
  } catch (error) {
    console.error('Error saving notes:', error);
  }
  
  return note;
};

// Load notes on startup
const loadNotes = async () => {
  try {
    const data = await fs.readFile('notes.json', 'utf8');
    notes = JSON.parse(data);
  } catch (error) {
    console.log('No existing notes file, starting fresh');
    notes = [];
  }
};

// Get user's recent notes
const getUserNotes = (phoneNumber, limit = 5) => {
  return notes
    .filter(note => note.phoneNumber === phoneNumber)
    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
    .slice(0, limit);
};

// Main WhatsApp webhook
app.post('/webhook', upload.single('media'), async (req, res) => {
  const { From, Body, MediaUrl0, MediaContentType0 } = req.body;
  const phoneNumber = From.replace('whatsapp:', '');
  
  try {
    let responseMessage = '';
    
    // Handle different types of messages
    if (MediaUrl0) {
      // Handle media (voice, image, video)
      let mediaType = 'media';
      if (MediaContentType0.startsWith('audio')) mediaType = 'voice';
      else if (MediaContentType0.startsWith('image')) mediaType = 'image';
      else if (MediaContentType0.startsWith('video')) mediaType = 'video';
      
      const note = await saveNote(phoneNumber, Body || 'Media file', mediaType, MediaUrl0);
      responseMessage = `📝 आपली ${mediaType === 'voice' ? 'आवाजाची टिप्पणी' : 'फाइल'} सेव्ह झाली!\n⏰ वेळ: ${note.dateFormatted}`;
      
    } else if (Body) {
      const message = Body.trim().toLowerCase();
      
      // Handle commands
      if (message === '/help' || message === 'help' || message === 'मदत') {
        responseMessage = `🤖 *Note-Taking Bot मदत*\n\n` +
          `📝 *नोट्स सेव्ह करा:*\n` +
          `• कोणताही मजकूर टाइप करा\n` +
          `• आवाजाची टिप्पणी पाठवा\n` +
          `• फोटो किंवा व्हिडिओ पाठवा\n\n` +
          `📋 *Commands:*\n` +
          `• /recent - अलीकडील 5 नोट्स पहा\n` +
          `• /summary - आजच्या नोट्सचा सारांश\n` +
          `• /translate - इंग्रजीत अनुवाद\n` +
          `• /help - ही मदत\n\n` +
          `💡 फक्त मजकूर लिहा आणि तो automatic सेव्ह होईल!`;
          
      } else if (message === '/recent' || message === 'recent' || message === 'अलीकडील') {
        const recentNotes = getUserNotes(phoneNumber, 5);
        if (recentNotes.length === 0) {
          responseMessage = `📝 अजून कोणत्याही नोट्स नाहीत. काही लिहून पहा!`;
        } else {
          responseMessage = `📋 *अलीकडील नोट्स:*\n\n`;
          recentNotes.forEach((note, index) => {
            responseMessage += `${index + 1}. *${note.dateFormatted}*\n`;
            if (note.type === 'text') {
              responseMessage += `${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}\n\n`;
            } else {
              responseMessage += `📎 ${note.type} file\n\n`;
            }
          });
        }
        
      } else if (message === '/summary' || message === 'summary' || message === 'सारांश') {
        const todayNotes = notes.filter(note => 
          note.phoneNumber === phoneNumber && 
          new Date(note.timestamp).toDateString() === new Date().toDateString()
        );
        
        if (todayNotes.length === 0) {
          responseMessage = `📝 आज कोणत्याही नोट्स नाहीत.`;
        } else {
          const notesText = todayNotes.map(note => note.content).join('\n');
          const summary = await callDeepSeekAPI(`कृपया या मराठी नोट्सचा एक छोटा सारांश द्या:\n${notesText}`);
          responseMessage = `📊 *आजचा सारांश:*\n\n${summary}`;
        }
        
      } else if (message === '/translate' || message === 'translate' || message === 'भाषांतर') {
        const recentNote = getUserNotes(phoneNumber, 1)[0];
        if (!recentNote) {
          responseMessage = `📝 भाषांतरासाठी कोणत्याही नोट्स नाहीत.`;
        } else {
          const translation = await callDeepSeekAPI(`Translate this Marathi text to English: ${recentNote.content}`);
          responseMessage = `🌐 *English Translation:*\n\n${translation}`;
        }
        
      } else {
        // Save as regular note
        const note = await saveNote(phoneNumber, Body, 'text');
        responseMessage = `✅ नोट सेव्ह झाली!\n⏰ वेळ: ${note.dateFormatted}\n\n💡 /help टाइप करा अधिक options साठी`;
      }
    }
    
    // Send response via Twilio
    await client.messages.create({
      body: responseMessage,
      from: process.env.TWILIO_WHATSAPP_NUMBER,
      to: From
    });
    
    res.status(200).send('OK');
    
  } catch (error) {
    console.error('Webhook error:', error);
    res.status(500).send('Error processing message');
  }
});

// Web dashboard for teachers/caregivers
app.get('/dashboard/:phoneNumber', async (req, res) => {
  const { phoneNumber } = req.params;
  const userNotes = notes.filter(note => note.phoneNumber === phoneNumber);
  
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Notes Dashboard</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .note { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .timestamp { color: #666; font-size: 0.9em; }
        .content { margin: 10px 0; }
        .media { margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
      </style>
    </head>
    <body>
      <h1>Notes for ${phoneNumber}</h1>
      <div id="notes">
        ${userNotes.map(note => `
          <div class="note">
            <div class="timestamp">${note.dateFormatted}</div>
            <div class="content">${note.content}</div>
            ${note.mediaUrl ? `<div class="media">📎 ${note.type} file</div>` : ''}
            <button onclick="translate('${note.id}')">Translate to English</button>
          </div>
        `).join('')}
      </div>
      
      <script>
        async function translate(noteId) {
          // Implementation for translation
          alert('Translation feature - integrate with backend');
        }
      </script>
    </body>
    </html>
  `;
  
  res.send(html);
});

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'OK', timestamp: new Date().toISOString() });
});

// Initialize and start server
const init = async () => {
  await ensureUploadsDir();
  await loadNotes();
  
  app.listen(PORT, () => {
    console.log(`🚀 WhatsApp Notes Bot running on port ${PORT}`);
    console.log(`📱 Webhook URL: https://your-domain.com/webhook`);
    console.log(`📊 Dashboard: https://your-domain.com/dashboard/PHONE_NUMBER`);
  });
};

init().catch(console.error);

module.exports = app;
